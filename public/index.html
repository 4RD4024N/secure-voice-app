<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Güvenli Sesli Sohbet</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#6ee7b7;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: linear-gradient(180deg,#071023 0%, #071428 60%);
      color:#e6eef8;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }
    .app{
      width:100%;
      max-width:820px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 30px rgba(2,6,23,0.6);
      border: 1px solid rgba(255,255,255,0.03);
    }
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h2{margin:0;font-weight:600;color:var(--accent)}
    .controls{display:grid;grid-template-columns:1fr 220px;gap:12px;align-items:start}
    .card{background:var(--card);padding:14px;border-radius:10px}
    input[type="text"], button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    button{background:var(--accent);color:#052018;border:none;font-weight:600;cursor:pointer}
    .right{display:flex;flex-direction:column;gap:8px}
    #users{margin-top:12px;background:var(--glass);padding:10px;border-radius:8px;min-height:64px;white-space:pre-line;color:var(--muted)}
    .mic-panel{display:flex;flex-direction:column;gap:8px}
    .meter{background:#0b1320;border-radius:6px;height:12px;overflow:hidden}
    .meter > .level{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#22c1c3)}
    .mic-row{display:flex;gap:8px;align-items:center}
    #micLevel{appearance:none;width:100%}
    #micLevel::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px rgba(110,231,183,0.3)}
    .remote-audios{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    audio{outline:none}
    .muted{opacity:0.6}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    @media (max-width:700px){.controls{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h2>Güvenli Sesli Sohbet</h2>
      <div style="color:var(--muted);font-size:13px">Simple WebRTC + Signaling</div>
    </header>

    <div class="controls">
      <div class="card">
        <input id="roomId" type="text" placeholder="Oda ID gir (örnek: dostlar)" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="displayName" type="text" maxlength="16" placeholder="İsim (en fazla 16 karakter)" style="flex:1" />
          <button id="setNameBtn" style="width:140px">İsim Değiştir</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="createBtn">Oda Oluştur</button>
          <button id="joinBtn">Odaya Katıl</button>
        </div>
        <p id="status" style="margin-top:10px;color:var(--muted)"></p>
        <p style="margin:6px 0"><b>Paylaş:</b> <span id="shareLink" class="muted"></span></p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="font-weight:600">Oluşturulan Odalar</div>
          <button id="refreshRooms" style="background:transparent;color:var(--accent);border:1px solid rgba(110,231,183,0.08);padding:6px 8px;font-size:13px">Yenile</button>
        </div>
        <div id="roomsList" style="margin-top:8px;background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;min-height:48px;color:var(--muted)">Yükleniyor...</div>
        <div id="users"><b>Bağlı Kullanıcılar:</b></div>
        <div class="remote-audios" id="remoteAudios"></div>
        <div style="margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="font-weight:600">Oda Sohbeti</div>
            <div style="font-size:12px;color:var(--muted)">Mesajlar herkese gönderilir</div>
          </div>
          <div id="chatMessages" style="max-height:200px;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;color:var(--muted)"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="chatInput" placeholder="Mesaj yaz..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit" />
            <button id="chatSend" style="padding:8px 12px;border-radius:8px">Gönder</button>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card mic-panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">Mikrofon</div>
            <div id="micState" style="font-size:13px;color:var(--muted)">Durum: Kapalı</div>
          </div>
          <div class="mic-row">
            <input id="micLevel" type="range" min="0" max="100" value="0" disabled />
          </div>
          <div class="meter" aria-hidden="true"><div class="level" id="levelBar"></div></div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="muteBtn">Mikrofonu Aç</button>
            <button id="ngrokHelp" style="background:transparent;color:var(--accent);border:1px solid rgba(110,231,183,0.12)">Bağlantı Yardım</button>
          </div>
        </div>
        <footer>Not: Tarayıcı mikrofon izinleri gereklidir.</footer>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    const socket = io();
    let peers = {};
    let localStream = null;
    let currentRoom = "";
    let socketNames = {};
    let myName = null;
    let audioCtx = null;
    let analyser = null;
    let dataArray = null;
    let rafId = null;
    let isMicOn = false;

    const createBtn = document.getElementById('createBtn');
    const joinBtn = document.getElementById('joinBtn');
    const muteBtn = document.getElementById('muteBtn');
    const micLevel = document.getElementById('micLevel');
    const levelBar = document.getElementById('levelBar');
    const micState = document.getElementById('micState');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatMessages = document.getElementById('chatMessages');

    createBtn.onclick = createRoom;
    joinBtn.onclick = joinRoom;
    muteBtn.onclick = toggleMic;
    document.getElementById('setNameBtn').onclick = setName;
    document.getElementById('refreshRooms').onclick = requestRooms;

    function setStatus(msg) { document.getElementById('status').innerText = msg; }

    async function ensureMic() {
      if (localStream) return localStream;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupAnalyzer(localStream);
        return localStream;
      } catch (e) {
        setStatus('Mikrofon erişimi reddedildi veya bulunamadı.');
        throw e;
      }
    }

    function createRoom() {
      const roomId = document.getElementById('roomId').value;
      if (!roomId) return setStatus('Lütfen bir oda ID gir.');
      socket.emit('create-room', roomId);
    }

    function setName(){
      const input = document.getElementById('displayName');
      if (!input) return;
      const name = (input.value || '').trim();
      if (!name) return setStatus('Lütfen geçerli bir isim girin.');
      if (name.length > 16) return setStatus('İsim 16 karakterden uzun olamaz.');
      socket.emit('set-name', name);
    }

    async function joinRoom() {
      const roomId = document.getElementById('roomId').value;
      if (!roomId) return setStatus('Lütfen bir oda ID gir.');
      try {
        await ensureMic();
        socket.emit('join-room', roomId);
      } catch (e) {
        console.error(e);
      }
    }

    socket.on('roomExists', () => setStatus('❌ Bu oda zaten var!'));
    socket.on('roomNotFound', () => setStatus('❌ Böyle bir oda yok.'));
    socket.on('roomFull', () => setStatus('❌ Oda dolu (5 kişi sınırı).'));

    socket.on('roomCreated', (roomId) => {
      setStatus('✅ Oda oluşturuldu.');
      currentRoom = roomId;
      document.getElementById('shareLink').innerText = window.location.origin + '?room=' + roomId;
      // refresh list when a room is created
      requestRooms();
    });

    socket.on('chat-message', (payload) => {
      // payload: { fromId, fromName, text, ts }
      appendChatMessage(payload.fromName || payload.from, payload.text, payload.ts, payload.fromId || payload.from);
    });

    socket.on('name-set', (res) => {
      if (res && res.success) {
        myName = res.name;
        socketNames[socket.id] = res.name;
        setStatus('İsim ayarlandı: ' + res.name);
      } else {
        setStatus('İsim değiştirilemedi: ' + (res && res.reason ? res.reason : 'hata'));
      }
    });

    socket.on('name-changed', ({ id, name }) => {
      if (!id) return;
      if (name) socketNames[id] = name; else delete socketNames[id];
      refreshUsersList();
    });

    socket.on('left-room', (roomId) => {
      if (currentRoom === roomId) {
        setStatus('✅ Odanan ayrıldınız.');
        currentRoom = '';
        document.getElementById('shareLink').innerText = '';
        requestRooms();
        refreshUsersList();
      }
    });

    socket.on('room-deleted', (roomId) => {
      if (currentRoom === roomId) {
        setStatus('⚠️ Oda silindi: ' + roomId);
        currentRoom = '';
        document.getElementById('shareLink').innerText = '';
      }
      requestRooms();
      refreshUsersList();
    });

    socket.on('room-list', (rooms) => {
      const el = document.getElementById('roomsList');
      if (!rooms || !rooms.length) {
        el.innerText = '(hiç oda yok)';
        return;
      }
      el.innerHTML = '';
      rooms.forEach(r => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.marginBottom = '6px';

        const label = document.createElement('div');
        label.style.color = 'var(--muted)';
        label.innerText = `${r.id}  —  ${r.size} kişi`;
        if (r.id === currentRoom) {
          label.innerText += '   (joined)';
          label.style.fontWeight = '600';
          label.style.color = 'var(--accent)';
        }

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '6px';

        const joinBtn = document.createElement('button');
        joinBtn.innerText = 'Katıl';
        joinBtn.onclick = () => { document.getElementById('roomId').value = r.id; joinRoom(); };

        const leaveBtn = document.createElement('button');
        leaveBtn.innerText = 'Ayrıl';
        leaveBtn.style.background = 'transparent';
        leaveBtn.style.color = 'var(--muted)';
        leaveBtn.onclick = () => { socket.emit('leave-room', r.id); };

        const delBtn = document.createElement('button');
        delBtn.innerText = 'Sil';
        delBtn.style.background = 'transparent';
        delBtn.style.color = '#ff7b7b';
        delBtn.onclick = () => {
          if (!confirm('Bu odayı silmek istediğinizden emin misiniz?')) return;
          socket.emit('delete-room', r.id);
        };

        // show appropriate buttons
        actions.appendChild(joinBtn);
        actions.appendChild(leaveBtn);
        actions.appendChild(delBtn);

        row.appendChild(label);
        row.appendChild(actions);
        el.appendChild(row);
      });
    });

    socket.on('joinedRoom', async (roomId, others, history, names) => {
      setStatus('✅ Odaya katıldın.');
      currentRoom = roomId;
      document.getElementById('shareLink').innerText = window.location.origin + '?room=' + roomId;
      if (!localStream) await ensureMic();

      // render chat history for this room (WhatsApp-like)
      chatMessages.innerHTML = '';
      // save known names mapping for this room
      socketNames = names || {};
      // update myName if server knows it
      if (socketNames[socket.id]) myName = socketNames[socket.id];
      if (Array.isArray(history) && history.length) {
        history.forEach(m => appendChatMessage(m.fromName || m.from, m.text, m.ts, m.fromId || m.from));
      }

      socket.on('user-joined', (payload) => {
        const id = payload && payload.id ? payload.id : payload;
        const name = payload && payload.name ? payload.name : null;
        if (name) socketNames[id] = name;
        const peer = createPeer(id);
        peers[id] = peer;
        // attach tracks
        localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
      });

      socket.on('signal', ({ from, data }) => {
        if (!peers[from]) {
          const peer = createPeer(from, false);
          peers[from] = peer;
        }
        peers[from].signal(data);
      });

      socket.on('user-left', (id) => {
        if (peers[id]) {
          peers[id].destroy();
          delete peers[id];
        }
        // remove name mapping
        if (socketNames[id]) delete socketNames[id];
        refreshUsersList();
      });
      refreshUsersList();
    });

    function createPeer(id, initiator = true) {
      const peer = new SimplePeer({
        initiator,
        trickle: false,
        stream: localStream,
        config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
      });

      peer.on('signal', data => socket.emit('signal', { to: id, data }));

      peer.on('stream', stream => {
        // append remote audio to container
        const container = document.getElementById('remoteAudios');
        const wrapper = document.createElement('div');
        wrapper.className = 'card';
        const label = document.createElement('div');
        label.style.fontSize = '13px';
        label.style.color = 'var(--muted)';
        label.innerText = 'Kullanıcı: ' + id;
        const audio = document.createElement('audio');
        audio.srcObject = stream;
        audio.autoplay = true;
        audio.controls = true;
        wrapper.appendChild(label);
        wrapper.appendChild(audio);
        container.appendChild(wrapper);
        refreshUsersList();
      });

      peer.on('connect', () => { refreshUsersList(); });

      return peer;
    }

    function refreshUsersList(){
      const el = document.getElementById('users');
      const ids = Object.keys(peers);
      const lines = [];
      // show current user first (if available)
      if (socket && socket.id) {
        const display = myName || socketNames[socket.id] || socket.id;
        lines.push('• ' + display + '  (you)');
      }
      // then show other connected peers
      ids.forEach(id => {
        if (id === socket.id) return;
        const display = socketNames[id] || id;
        lines.push('• ' + display);
      });
      el.innerText = 'Bağlı Kullanıcılar:' + (lines.length ? '\n' + lines.join('\n') : '\n(hiç kimse)');
    }

    function setupAnalyzer(stream){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        const bufferLength = analyser.fftSize;
        dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);
        isMicOn = true;
        micState.innerText = 'Durum: Açık';
        muteBtn.innerText = 'Mikrofonu Kapat';
        animateMeter();
      }catch(e){
        console.warn('Analyzer setup failed', e);
      }
    }

    function animateMeter(){
      if (!analyser) return;
      analyser.getByteTimeDomainData(dataArray);
      // compute RMS
      let sum = 0;
      for(let i=0;i<dataArray.length;i++){
        const v = (dataArray[i] - 128) / 128;
        sum += v * v;
      }
      const rms = Math.sqrt(sum / dataArray.length);
      const level = Math.min(100, Math.round(rms * 200));
      micLevel.value = level;
      levelBar.style.width = level + '%';
      rafId = requestAnimationFrame(animateMeter);
    }

    async function toggleMic(){
      if (!localStream){
        try{ await ensureMic(); }
        catch{return}
      }
      const tracks = localStream.getAudioTracks();
      if (!tracks.length) return;
      const enabled = tracks[0].enabled;
      tracks.forEach(t => t.enabled = !enabled);
      isMicOn = !enabled;
      micState.innerText = 'Durum: ' + (isMicOn ? 'Açık' : 'Kapalı');
      muteBtn.innerText = isMicOn ? 'Mikrofonu Kapat' : 'Mikrofonu Aç';
      if (!isMicOn){ micLevel.value = 0; levelBar.style.width = '0%'; }
    }

    // handle ngrok help button
    document.getElementById('ngrokHelp').onclick = () => {
      alert('ngrok kullanımı için hesabınıza authtoken ekleyin. README dosyasına bakın.');
    };

    // parse room param on load
    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      const room = params.get('room');
      if (room) {
        document.getElementById('roomId').value = room;
        joinRoom();
      }
      // request existing rooms on load
      requestRooms();
    };

    function requestRooms(){
      socket.emit('get-rooms');
    }

    function appendChatMessage(fromName, text, ts, fromId){
      const row = document.createElement('div');
      row.style.padding = '6px';
      row.style.borderBottom = '1px solid rgba(255,255,255,0.01)';
      const id = fromId || fromName;
      const display = (id === socket.id) ? ((myName || socketNames[socket.id] || socket.id) + ' (you)') : (fromName || id);
      const time = ts ? new Date(ts).toLocaleTimeString() : '';
      row.innerHTML = `<div style="font-size:12px;color:var(--muted)">${escapeHtml(display)} <span style='float:right;font-size:11px;color:rgba(255,255,255,0.2)'>${time}</span></div><div style="margin-top:4px">${escapeHtml(text)}</div>`;
      chatMessages.appendChild(row);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(unsafe){
      return unsafe.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; });
    }

    chatSend.onclick = () => {
      const text = chatInput.value && chatInput.value.trim();
      if (!text) return;
      if (!currentRoom) { setStatus('Önce bir odaya katılın.'); return; }
      socket.emit('chat-message', { roomId: currentRoom, text });
      chatInput.value = '';
    };

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); chatSend.click(); }
    });

  </script>
</body>
</html>
