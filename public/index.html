<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GÃ¼venli Sesli Sohbet</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header>
      <h2>GÃ¼venli Sesli Sohbet</h2>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="color:var(--muted);font-size:13px">Simple WebRTC + Signaling</div>
        <button id="themeToggle" class="ghost" style="padding:7px 16px;font-size:14px;min-width:90px" title="Tema DeÄŸiÅŸtir">ğŸŒ™/â˜€ï¸</button>
      </div>
    </header>

    <div class="controls">
      <div class="card">
        <input id="roomId" type="text" placeholder="Oda ID gir (Ã¶rnek: dostlar)" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="displayName" type="text" maxlength="16" placeholder="Ä°sim (en fazla 16 karakter)" style="flex:1" />
          <button id="setNameBtn" style="width:140px">Ä°sim DeÄŸiÅŸtir</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="createBtn">Oda OluÅŸtur</button>
          <button id="joinBtn">Odaya KatÄ±l</button>
        </div>
        <p id="status" style="margin-top:10px;color:var(--muted)"></p>
        <p style="margin:6px 0"><b>PaylaÅŸ:</b> <span id="shareLink" class="muted"></span></p>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="font-weight:600">OluÅŸturulan Odalar</div>
          <button id="refreshRooms" style="background:transparent;color:var(--accent);border:1px solid rgba(110,231,183,0.08);padding:6px 8px;font-size:13px">Yenile</button>
        </div>
        <div id="roomsList" style="margin-top:8px;background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;min-height:48px;color:var(--muted)">YÃ¼kleniyor...</div>
        <div id="users"><b>BaÄŸlÄ± KullanÄ±cÄ±lar:</b></div>
        <div class="remote-audios" id="remoteAudios"></div>
        <div style="margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="font-weight:600">Oda Sohbeti</div>
            <div style="font-size:12px;color:var(--muted)">Mesajlar herkese gÃ¶nderilir</div>
          </div>
          <div id="chatMessages" style="max-height:200px;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px;color:var(--muted)"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="chatInput" placeholder="Mesaj yaz..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit" />
            <button id="chatSend" style="padding:8px 12px;border-radius:8px">GÃ¶nder</button>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card mic-panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:600">Mikrofon</div>
            <div id="micState" style="font-size:13px;color:var(--muted)">Durum: KapalÄ±</div>
          </div>
          <div class="mic-row">
            <input id="micLevel" type="range" min="0" max="100" value="0" disabled />
          </div>
          <div class="meter" aria-hidden="true"><div class="level" id="levelBar"></div></div>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="muteBtn">Mikrofonu AÃ§</button>
            <button id="ngrokHelp" style="background:transparent;color:var(--accent);border:1px solid rgba(110,231,183,0.12)">BaÄŸlantÄ± YardÄ±m</button>
          </div>
        </div>
        <footer>Not: TarayÄ±cÄ± mikrofon izinleri gereklidir.</footer>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    // Theme toggle logic
    const themeToggle = document.getElementById('themeToggle');
    function setTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-theme');
        localStorage.setItem('theme', 'light');
        themeToggle.textContent = 'â˜€ï¸ Koyu';
      } else {
        document.body.classList.remove('light-theme');
        localStorage.setItem('theme', 'dark');
        themeToggle.textContent = 'ğŸŒ™ AÃ§Ä±k';
      }
    }
    themeToggle.onclick = function() {
      if (document.body.classList.contains('light-theme')) {
        setTheme('dark');
      } else {
        setTheme('light');
      }
    };
    // On load, set theme from localStorage
    (function(){
      const saved = localStorage.getItem('theme');
      setTheme(saved === 'light' ? 'light' : 'dark');
    })();
    const socket = io();
    let peers = {};
    let localStream = null;
    let currentRoom = "";
    let socketNames = {};
    let myName = null;
    let audioCtx = null;
    let analyser = null;
    let dataArray = null;
    let rafId = null;
    let isMicOn = false;

    const createBtn = document.getElementById('createBtn');
    const joinBtn = document.getElementById('joinBtn');
    const muteBtn = document.getElementById('muteBtn');
    const micLevel = document.getElementById('micLevel');
    const levelBar = document.getElementById('levelBar');
    const micState = document.getElementById('micState');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatMessages = document.getElementById('chatMessages');

    createBtn.onclick = createRoom;
    joinBtn.onclick = joinRoom;
    muteBtn.onclick = toggleMic;
    document.getElementById('setNameBtn').onclick = setName;
    document.getElementById('refreshRooms').onclick = requestRooms;

    function setStatus(msg) { document.getElementById('status').innerText = msg; }

    async function ensureMic() {
      if (localStream) return localStream;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            noiseSuppression: true,
            echoCancellation: true,
            autoGainControl: true,
            sampleRate: 48000
          }
        });
        setupAnalyzer(localStream);
        return localStream;
      } catch (e) {
        setStatus('Mikrofon eriÅŸimi reddedildi veya bulunamadÄ±.');
        throw e;
      }
    }

    function createRoom() {
      const roomId = document.getElementById('roomId').value;
      if (!roomId) return setStatus('LÃ¼tfen bir oda ID gir.');
      socket.emit('create-room', roomId);
    }

    function setName(){
      const input = document.getElementById('displayName');
      if (!input) return;
      const name = (input.value || '').trim();
      if (!name) return setStatus('LÃ¼tfen geÃ§erli bir isim girin.');
      if (name.length > 16) return setStatus('Ä°sim 16 karakterden uzun olamaz.');
      socket.emit('set-name', name);
    }

    async function joinRoom() {
      const roomId = document.getElementById('roomId').value;
      if (!roomId) return setStatus('LÃ¼tfen bir oda ID gir.');
      try {
        await ensureMic();
        socket.emit('join-room', roomId);
      } catch (e) {
        console.error(e);
      }
    }

    socket.on('roomExists', () => setStatus('âŒ Bu oda zaten var!'));
    socket.on('roomNotFound', () => setStatus('âŒ BÃ¶yle bir oda yok.'));
    socket.on('roomFull', () => setStatus('âŒ Oda dolu (5 kiÅŸi sÄ±nÄ±rÄ±).'));

    socket.on('roomCreated', (roomId) => {
      setStatus('âœ… Oda oluÅŸturuldu.');
      currentRoom = roomId;
      document.getElementById('shareLink').innerText = window.location.origin + '?room=' + roomId;
      // refresh list when a room is created
      requestRooms();
    });

    socket.on('chat-message', (payload) => {
      // payload: { fromId, fromName, text, ts }
      appendChatMessage(payload.fromName || payload.from, payload.text, payload.ts, payload.fromId || payload.from);
    });

    socket.on('name-set', (res) => {
      if (res && res.success) {
        myName = res.name;
        socketNames[socket.id] = res.name;
        setStatus('Ä°sim ayarlandÄ±: ' + res.name);
      } else {
        setStatus('Ä°sim deÄŸiÅŸtirilemedi: ' + (res && res.reason ? res.reason : 'hata'));
      }
    });

    socket.on('name-changed', ({ id, name }) => {
      if (!id) return;
      if (name) socketNames[id] = name; else delete socketNames[id];
      // update any remote audio labels
      const labels = document.querySelectorAll('[data-peer-id="' + id + '"]');
      labels.forEach(el => {
        if (el.tagName && el.tagName.toLowerCase() === 'div') {
          el.innerText = 'KullanÄ±cÄ±: ' + (name || id);
        }
      });
      refreshUsersList();
    });

    socket.on('left-room', (roomId) => {
      if (currentRoom === roomId) {
        setStatus('âœ… Odanan ayrÄ±ldÄ±nÄ±z.');
        currentRoom = '';
        document.getElementById('shareLink').innerText = '';
        requestRooms();
        refreshUsersList();
      }
    });

    socket.on('room-deleted', (roomId) => {
      if (currentRoom === roomId) {
        setStatus('âš ï¸ Oda silindi: ' + roomId);
        currentRoom = '';
        document.getElementById('shareLink').innerText = '';
      }
      requestRooms();
      refreshUsersList();
    });

    socket.on('room-list', (rooms) => {
      const el = document.getElementById('roomsList');
      if (!rooms || !rooms.length) {
        el.innerText = '(hiÃ§ oda yok)';
        return;
      }
      el.innerHTML = '';
      rooms.forEach(r => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.marginBottom = '6px';

        const label = document.createElement('div');
        label.style.color = 'var(--muted)';
        label.innerText = `${r.id}  â€”  ${r.size} kiÅŸi`;
        if (r.id === currentRoom) {
          label.innerText += '   (joined)';
          label.style.fontWeight = '600';
          label.style.color = 'var(--accent)';
        }

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '6px';

        const joinBtn = document.createElement('button');
        joinBtn.innerText = 'KatÄ±l';
        joinBtn.onclick = () => { document.getElementById('roomId').value = r.id; joinRoom(); };

        const leaveBtn = document.createElement('button');
        leaveBtn.innerText = 'AyrÄ±l';
        leaveBtn.style.background = 'transparent';
        leaveBtn.style.color = 'var(--muted)';
        leaveBtn.onclick = () => { socket.emit('leave-room', r.id); };

        const delBtn = document.createElement('button');
        delBtn.innerText = 'Sil';
        delBtn.style.background = 'transparent';
        delBtn.style.color = '#ff7b7b';
        delBtn.onclick = () => {
          if (!confirm('Bu odayÄ± silmek istediÄŸinizden emin misiniz?')) return;
          socket.emit('delete-room', r.id);
        };

        // show appropriate buttons
        actions.appendChild(joinBtn);
        actions.appendChild(leaveBtn);
        actions.appendChild(delBtn);

        row.appendChild(label);
        row.appendChild(actions);
        el.appendChild(row);
      });
    });

    socket.on('joinedRoom', async (roomId, others, history, names) => {
      setStatus('âœ… Odaya katÄ±ldÄ±n.');
      currentRoom = roomId;
      document.getElementById('shareLink').innerText = window.location.origin + '?room=' + roomId;
      if (!localStream) await ensureMic();

      // render chat history for this room (WhatsApp-like)
      chatMessages.innerHTML = '';
      // save known names mapping for this room
      socketNames = names || {};
      // update myName if server knows it
      if (socketNames[socket.id]) myName = socketNames[socket.id];
      if (Array.isArray(history) && history.length) {
        history.forEach(m => appendChatMessage(m.fromName || m.from, m.text, m.ts, m.fromId || m.from));
      }

      socket.on('user-joined', (payload) => {
        const id = payload && payload.id ? payload.id : payload;
        const name = payload && payload.name ? payload.name : null;
        if (name) socketNames[id] = name;
        const peer = createPeer(id);
        peers[id] = peer;
        // attach tracks
        localStream.getTracks().forEach(track => peer.addTrack(track, localStream));
      });

      socket.on('signal', ({ from, data }) => {
        if (!peers[from]) {
          const peer = createPeer(from, false);
          peers[from] = peer;
        }
        peers[from].signal(data);
      });

      socket.on('user-left', (id) => {
        if (peers[id]) {
          peers[id].destroy();
          delete peers[id];
        }
        // remove name mapping
        if (socketNames[id]) delete socketNames[id];
        refreshUsersList();
      });
      refreshUsersList();
    });

    function createPeer(id, initiator = true) {
      const peer = new SimplePeer({
        initiator,
        trickle: false,
        stream: localStream,
        config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
      });

      peer.on('signal', data => socket.emit('signal', { to: id, data }));

      peer.on('stream', stream => {
        // append remote audio to container
        const container = document.getElementById('remoteAudios');
        const wrapper = document.createElement('div');
        wrapper.className = 'card';
        wrapper.dataset.peerId = id;
        const label = document.createElement('div');
        label.style.fontSize = '13px';
        label.style.color = 'var(--muted)';
        const display = socketNames[id] || id;
        label.innerText = 'KullanÄ±cÄ±: ' + display;
        label.dataset.peerId = id;
        const audio = document.createElement('audio');
        audio.srcObject = stream;
        audio.autoplay = true;
        audio.controls = true;
        wrapper.appendChild(label);
        wrapper.appendChild(audio);
        container.appendChild(wrapper);
        refreshUsersList();
      });

      peer.on('connect', () => { refreshUsersList(); });

      return peer;
    }

    function refreshUsersList(){
      const el = document.getElementById('users');
      const ids = Object.keys(peers);
      const lines = [];
      // show current user first (if available)
      if (socket && socket.id) {
        const display = myName || socketNames[socket.id] || socket.id;
        lines.push('â€¢ ' + display + '  (you)');
      }
      // then show other connected peers
      ids.forEach(id => {
        if (id === socket.id) return;
        const display = socketNames[id] || id;
        lines.push('â€¢ ' + display);
      });
      el.innerText = 'BaÄŸlÄ± KullanÄ±cÄ±lar:' + (lines.length ? '\n' + lines.join('\n') : '\n(hiÃ§ kimse)');
    }

    function setupAnalyzer(stream){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        const bufferLength = analyser.fftSize;
        dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);
        isMicOn = true;
        micState.innerText = 'Durum: AÃ§Ä±k';
        muteBtn.innerText = 'Mikrofonu Kapat';
        animateMeter();
      }catch(e){
        console.warn('Analyzer setup failed', e);
      }
    }

    function animateMeter(){
      if (!analyser) return;
      analyser.getByteTimeDomainData(dataArray);
      // compute RMS
      let sum = 0;
      for(let i=0;i<dataArray.length;i++){
        const v = (dataArray[i] - 128) / 128;
        sum += v * v;
      }
      const rms = Math.sqrt(sum / dataArray.length);
      const level = Math.min(100, Math.round(rms * 200));
      micLevel.value = level;
      levelBar.style.width = level + '%';
      rafId = requestAnimationFrame(animateMeter);
    }

    async function toggleMic(){
      if (!localStream){
        try{ await ensureMic(); }
        catch{return}
      }
      const tracks = localStream.getAudioTracks();
      if (!tracks.length) return;
      const enabled = tracks[0].enabled;
      tracks.forEach(t => t.enabled = !enabled);
      isMicOn = !enabled;
      micState.innerText = 'Durum: ' + (isMicOn ? 'AÃ§Ä±k' : 'KapalÄ±');
      muteBtn.innerText = isMicOn ? 'Mikrofonu Kapat' : 'Mikrofonu AÃ§';
      if (!isMicOn){ micLevel.value = 0; levelBar.style.width = '0%'; }
    }

    // handle ngrok help button
    document.getElementById('ngrokHelp').onclick = () => {
      alert('ngrok kullanÄ±mÄ± iÃ§in hesabÄ±nÄ±za authtoken ekleyin. README dosyasÄ±na bakÄ±n.');
    };

    // parse room param on load
    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      const room = params.get('room');
      if (room) {
        document.getElementById('roomId').value = room;
        joinRoom();
      }
      // request existing rooms on load
      requestRooms();
    };

    function requestRooms(){
      socket.emit('get-rooms');
    }

    function appendChatMessage(fromName, text, ts, fromId){
      const row = document.createElement('div');
      row.className = 'chat-message';
      const id = fromId || fromName;
      const display = (id === socket.id) ? ((myName || socketNames[socket.id] || socket.id) + ' (you)') : (fromName || id);
      const time = ts ? new Date(ts).toLocaleTimeString() : '';
      row.innerHTML = `<div class="chat-meta">${escapeHtml(display)} <span style='float:right;font-size:11px;color:rgba(255,255,255,0.2)'>${time}</span></div><div>${escapeHtml(text)}</div>`;
      chatMessages.appendChild(row);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(unsafe){
      return unsafe.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]; });
    }

    chatSend.onclick = () => {
      const text = chatInput.value && chatInput.value.trim();
      if (!text) return;
      if (!currentRoom) { setStatus('Ã–nce bir odaya katÄ±lÄ±n.'); return; }
      socket.emit('chat-message', { roomId: currentRoom, text });
      chatInput.value = '';
    };

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); chatSend.click(); }
    });

  </script>
</body>
</html>
